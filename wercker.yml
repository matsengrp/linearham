box: debian:stretch

build:
    steps:
        - install-packages:
            packages: autoconf bison libblas-dev build-essential cmake curl doxygen flex git graphviz libgsl0-dev
                liblapack-dev libncurses-dev python-dev python-pip python-setuptools r-cran-ape
                r-cran-data.table r-cran-littler scons libtool libyaml-dev libyaml-cpp-dev libz-dev
        - pip-install:
            requirements_file: ""
            packages_list: "biopython colored-traceback dendropy jinja2 matplotlib nestly numpy psutil pysam pyyaml scipy"
        - script:
            name: initialize git submodules
            code: |
                git submodule update --init --recursive
        - script:
            name: install R packages
            code: |
                Rscript --slave --vanilla -e 'install.packages(c("phylotate", "Rcpp", "RcppArmadillo"), repos = "https://cloud.r-project.org")'
                Rscript --slave --vanilla -e 'install.packages("lib/phylomd", repos = NULL, type = "source")'
        - script:
            name: install RevBayes
            code: cd lib/revbayes/projects/cmake && ./build.sh
        - script:
            name: install partis and linearham
            code: scons --build-partis-linearham
        - script:
            name: run tests
            code: _build/test/test
        - script:
            name: run example command
            code: |
                scons --run-partis --fasta-path=data/liao_dataset.fasta --all-clonal-seqs
                scons --run-linearham --template-path=templates/revbayes_template.rev --mcmc-iter=25 --mcmc-thin=1 --tune-iter=0 --seed-seq=KC576081.1
        - script:
            name: build documentation
            code: doxygen Doxyfile
        - ematsen/gh-pages:
            token: $GITHUB_TOKEN
            repo: matsengrp/linearham
            path: html

    after-steps:
        - slack-notifier:
            url: $SLACK_URL
            channel: bcell
            username: linearham build
